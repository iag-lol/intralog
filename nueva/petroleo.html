<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets Table with Chart</title>
    <style>
        /* Reset básico y fuentes */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #212529;
            line-height: 1.6;
            font-size: 16px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(44, 62, 80, 0.5);
        }

        header h1 {
            margin: 0;
        }

        main {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            max-width: 1500px;
            margin: 20px auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-container input,
        .form-container select {
            padding: 10px;
            margin: 5px;
            width: 48%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-container button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
        }

        .styled-button {
            background-color: #3498db;
            color: white;
        }

        .styled-button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        .styled-button:active {
            background-color: #2471a3;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: scale(0.98);
        }

        .clear-button {
            background-color: #f39c12;
            color: white;
        }

        .clear-button:hover {
            background-color: #e67e22;
            transform: scale(1.05);
        }

        .export-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .export-button {
            padding: 5px 10px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            outline: none;
        }

        .download-button {
            background-color: #27ae60;
            color: white;
        }

        .download-button:hover {
            background-color: #229954;
            transform: scale(1.05);
        }

        .print-button {
            background-color: #8e44ad;
            color: white;
        }

        .print-button:hover {
            background-color: #7d3c98;
            transform: scale(1.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }

        th {
            background-color: #2c3e50;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr.selected-row {
            background-color: #3498db;
            color: white;
        }

        .notification {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }

        .highlight-red {
            color: red;
            font-weight: bold;
        }

        .highlight-green {
            color: green;
            font-weight: bold;
        }

        .chart-card {
            flex: 0 0 300px;
            margin-left: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .summary-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            border: 1px solid #ddd;
            text-align: center;
        }

        .summary-table th, .summary-table td {
            padding: 10px;
            border: 1px solid #ddd;
        }

        .summary-table th {
            background-color: #2c3e50;
            color: white;
        }

        aside {
            flex: 0 0 350px;
            margin-left: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }

            .form-container input,
            .form-container select,
            .form-container button {
                width: 100%;
            }

            .export-section {
                flex-direction: column;
                align-items: flex-end;
            }

            .export-button {
                width: 100%;
                margin-bottom: 10px;
            }

            .chart-card,
            aside {
                margin-left: 0;
                margin-top: 20px;
            }
        }
    </style>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <h1>Carga de Petroleo</h1>
    </header>

    <main>
        <div>
            <section class="form-container">
                <input type="text" id="num-interno" placeholder="Número Interno">
                <select id="ppu">
                    <option value="">Selecciona PPU</option>
                </select>
                <input type="text" id="estado" placeholder="Estado">
                <input type="text" id="litros" placeholder="Litros">
                <input type="text" id="ubicacion" placeholder="Ubicación">
                <input type="text" id="comentario" placeholder="Comentario">
                <button id="add-row-btn" class="styled-button">Agregar</button>
                <button id="search-row-btn" class="styled-button">Buscar</button>
                <button id="update-row-btn" class="styled-button">Modificar</button>
                <button id="delete-row-btn" class="styled-button">Eliminar</button>
                <button id="clear-btn" class="clear-button">Limpiar</button>
            </section>
            <section class="export-section">
                <button id="download-btn" class="download-button export-button">Descargar Excel</button>
                <button id="print-btn" class="print-button export-button">Imprimir Tabla</button>
            </section>
            <table id="levantamientos-table">
                <thead>
                    <tr>
                        <th>Número Interno</th>
                        <th>PPU</th>
                        <th>Estado</th>
                        <th>Litros</th>
                        <th>Ubicación</th>
                        <th>Comentario</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div class="chart-card">
            <canvas id="myChart"></canvas>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>Petroleo</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Petroleado</td>
                        <td id="positiveCount">0</td>
                    </tr>
                    <tr>
                        <td>Sin Petroleo</td>
                        <td id="spCount">0</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <aside>
            <table id="sin-petroleo-table">
                <thead>
                    <tr>
                        <th>Número Interno</th>
                        <th>PPU</th>
                        <th>Estado</th>
                        <th>Litros</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </aside>
    </main>

    <div id="notification" class="notification"></div>

    <script>
        const API_KEY = 'AIzaSyCyVG9n1lH7sfiSF2ABW6q5Q00xLVkXDgI';
        const CLIENT_ID = '185859829591-k1bspc3ksrha9pe2o7lmh5gv8q987a2m.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1bw3HxqGjmG7lyvJkvl-lqquB0UiuCsNBe48XhekwR8I';

        // Obtener el nombre de la hoja según la sesión
        const getSheetName = () => {
            const sessionName = sessionStorage.getItem('sessionName');
            if (sessionName === 'elRoble') return 'EL ROBLE!A2:G';
            if (sessionName === 'laReina') return 'LA REINA!A2:G';
            if (sessionName === 'mariaAngelica') return 'MARIA ANGELICA!A2:G';
            return 'TERMINALES!A2:G';
        }

        const RANGE = getSheetName();
        const DB_RANGE = 'DB!A2:B';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken;
        let myChart;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('add-row-btn').style.display = 'inline-block';
                document.getElementById('search-row-btn').style.display = 'inline-block';
                document.getElementById('update-row-btn').style.display = 'inline-block';
                document.getElementById('delete-row-btn').style.display = 'inline-block';
                document.getElementById('clear-btn').style.display = 'inline-block';
                document.getElementById('download-btn').style.display = 'inline-block';
                document.getElementById('print-btn').style.display = 'inline-block';
                fetchData();
                fetchDBData();
            }
        }

        function showNotification(message, color = '#28a745') {
            const notification = document.getElementById('notification');
            notification.innerText = message;
            notification.style.backgroundColor = color;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function clearForm() {
            document.getElementById('num-interno').value = '';
            document.getElementById('ppu').value = '';
            document.getElementById('estado').value = '';
            document.getElementById('litros').value = '';
            document.getElementById('ubicacion').value = '';
            document.getElementById('comentario').value = '';
        }

        async function fetchData() {
            console.log("Fetching data...");
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                });
                const data = response.result.values;
                if (data && data.length > 0) {
                    const tableBody = document.querySelector('#levantamientos-table tbody');
                    const sinPetroleoBody = document.querySelector('#sin-petroleo-table tbody');
                    tableBody.innerHTML = '';
                    sinPetroleoBody.innerHTML = '';
                    let spCount = 0;
                    let positiveCount = 0;
                    data.forEach((row, rowIndex) => {
                        const litros = row[3];
                        const litrosClass = litros === 'S/P' ? 'highlight-red' : parseInt(litros) > 0 ? 'highlight-green' : '';
                        if (litros === 'S/P') {
                            spCount++;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${row[0]}</td>
                                <td>${row[1]}</td>
                                <td>${row[2]}</td>
                                <td class="${litrosClass}">${row[3]}</td>
                            `;
                            sinPetroleoBody.appendChild(tr);
                        } else if (parseInt(litros) > 0) {
                            positiveCount++;
                        }
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td class="${litrosClass}">${row[3]}</td>
                            <td>${row[4]}</td>
                            <td>${row[5]}</td>
                            <td>
                                <button class="edit-button" data-row-index="${rowIndex + 2}">✏️</button>
                                <button class="delete-button" data-row-index="${rowIndex + 2}">❌</button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                    attachEditListeners();
                    attachDeleteListeners();
                    updateChart(spCount, positiveCount);
                    updateSummaryTable(spCount, positiveCount);
                } else {
                    console.log('No data found.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function fetchDBData() {
            console.log("Fetching DB data...");
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: DB_RANGE,
                });
                const data = response.result.values;
                if (data && data.length > 0) {
                    const ppuSelect = document.getElementById('ppu');
                    ppuSelect.innerHTML = '<option value="">Selecciona PPU</option>';
                    data.forEach(row => {
                        const option = document.createElement('option');
                        option.value = row[1];
                        option.text = row[1];
                        option.dataset.numInterno = row[0];
                        ppuSelect.appendChild(option);
                    });
                } else {
                    console.log('No data found in DB.');
                }
            } catch (error) {
                console.error('Error fetching DB data:', error);
            }
        }

        function attachEditListeners() {
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', async function () {
                    console.log("Edit button clicked...");
                    const rowIndex = this.dataset.rowIndex;
                    const row = this.closest('tr');
                    const numInterno = row.cells[0].innerText;
                    const ppu = row.cells[1].innerText;
                    const estado = row.cells[2].innerText;
                    const litros = row.cells[3].innerText;
                    const ubicacion = row.cells[4].innerText;
                    const comentario = row.cells[5].innerText;

                    document.getElementById('num-interno').value = numInterno;
                    document.getElementById('ppu').value = ppu;
                    document.getElementById('estado').value = estado;
                    document.getElementById('litros').value = litros;
                    document.getElementById('ubicacion').value = ubicacion;
                    document.getElementById('comentario').value = comentario;

                    document.getElementById('update-row-btn').dataset.rowIndex = rowIndex;
                });
            });
        }

        function attachDeleteListeners() {
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', async function () {
                    console.log("Delete button clicked...");
                    const rowIndex = this.dataset.rowIndex;
                    await deleteRow(rowIndex);
                });
            });
        }

        async function addRow(data) {
            console.log("Adding row...");
            if (!accessToken) {
                await tokenClient.requestAccessToken({
                    prompt: ''
                });
            }
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [data]
                    },
                });
                showNotification('Fila agregada correctamente');
                clearForm();
                fetchData();
            } catch (error) {
                console.error('Error adding row:', error);
                showNotification('Error agregando fila', '#dc3545');
            }
        }

        async function updateSheet(rowIndex, data) {
            console.log("Updating row...");
            if (!accessToken) {
                await tokenClient.requestAccessToken({
                    prompt: ''
                });
            }
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `TERMINALES!A${rowIndex}:G${rowIndex}`,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [data]
                    },
                });
                showNotification('Dato actualizado correctamente');
                clearForm();
                fetchData();
            } catch (error) {
                console.error('Error updating data:', error);
                showNotification('Error actualizando dato', '#dc3545');
            }
        }

        async function deleteRow(rowIndex) {
            console.log("Deleting row...");
            if (!accessToken) {
                await tokenClient.requestAccessToken({
                    prompt: ''
                });
            }
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: 0,
                                    dimension: 'ROWS',
                                    startIndex: rowIndex - 1,
                                    endIndex: rowIndex
                                }
                            }
                        }]
                    }
                });
                showNotification('Fila eliminada correctamente');
                clearForm();
                fetchData();
            } catch (error) {
                console.error('Error deleting row:', error);
                showNotification('Error eliminando fila', '#dc3545');
            }
        }

        async function searchRow() {
            console.log("Searching row...");
            const numInterno = document.getElementById('num-interno').value;
            const ppu = document.getElementById('ppu').value;
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                });
                const data = response.result.values;
                const foundRow = data.find(row => row[0] === numInterno || row[1] === ppu);
                if (foundRow) {
                    document.getElementById('num-interno').value = foundRow[0];
                    document.getElementById('ppu').value = foundRow[1];
                    document.getElementById('estado').value = foundRow[2];
                    document.getElementById('litros').value = foundRow[3];
                    document.getElementById('ubicacion').value = foundRow[4];
                    document.getElementById('comentario').value = foundRow[5];
                    showNotification('Dato encontrado correctamente');
                } else {
                    showNotification('Dato no encontrado', '#dc3545');
                }
            } catch (error) {
                console.error('Error searching row:', error);
                showNotification('Error buscando dato', '#dc3545');
            }
        }

        async function downloadExcel() {
            console.log("Downloading Excel...");
            const table = document.getElementById('levantamientos-table');
            const cloneTable = table.cloneNode(true);
            cloneTable.querySelectorAll('tr').forEach(row => row.deleteCell(-1)); // Remove last column
            const workbook = XLSX.utils.table_to_book(cloneTable, {
                sheet: "Sheet1",
                raw: true
            });
            XLSX.writeFile(workbook, 'levantamientos.xlsx');
            showNotification('Tabla descargada correctamente');
        }

        async function printTable() {
            console.log("Printing table...");
            const table = document.getElementById('levantamientos-table');
            const cloneTable = table.cloneNode(true);
            cloneTable.querySelectorAll('tr').forEach(row => row.deleteCell(-1)); // Remove last column
            const printWindow = window.open('', '', 'height=500,width=800');
            printWindow.document.write('<html><head><title>Tabla de Levantamientos</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('table {width: 100%; border-collapse: collapse;}');
            printWindow.document.write('table, th, td {border: 1px solid #ddd;}');
            printWindow.document.write('th, td {padding: 8px; text-align: left; font-size: 14px;}');
            printWindow.document.write('th {background-color: #2c3e50; color: white;}');
            printWindow.document.write('tr:nth-child(even) {background-color: #f2f2f2;}');
            printWindow.document.write('.highlight-red {color: red; font-weight: bold;}');
            printWindow.document.write('.highlight-green {color: green; font-weight: bold;}');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write(cloneTable.outerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            showNotification('Tabla impresa correctamente');
        }

        function updateChart(spCount, positiveCount) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myChart) {
                myChart.destroy();
            }
            myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Sin Petroleo', 'Con Petroleo'],
                    datasets: [{
                        data: [spCount, positiveCount],
                        backgroundColor: ['#ff6384', '#36a2eb'],
                        hoverBackgroundColor: ['#ff6384', '#36a2eb']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return tooltipItem.label + ': ' + tooltipItem.raw;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: 'white',
                            formatter: (value, context) => {
                                return value;
                            }
                        }
                    }
                }
            });
        }

        function updateSummaryTable(spCount, positiveCount) {
            document.getElementById('positiveCount').innerText = positiveCount;
            document.getElementById('spCount').innerText = spCount;
        }

        document.getElementById('add-row-btn').addEventListener('click', async function () {
            const numInterno = document.getElementById('num-interno').value;
            const ppu = document.getElementById('ppu').value;
            const estado = document.getElementById('estado').value;
            const litros = document.getElementById('litros').value;
            const ubicacion = document.getElementById('ubicacion').value;
            const comentario = document.getElementById('comentario').value;

            if (numInterno && ppu) {
                await addRow([numInterno, ppu, estado, litros, ubicacion, comentario]);
            } else {
                showNotification('Número Interno y PPU son obligatorios', '#dc3545');
            }
        });

        document.getElementById('update-row-btn').addEventListener('click', async function () {
            const rowIndex = this.dataset.rowIndex;
            const numInterno = document.getElementById('num-interno').value;
            const ppu = document.getElementById('ppu').value;
            const estado = document.getElementById('estado').value;
            const litros = document.getElementById('litros').value;
            const ubicacion = document.getElementById('ubicacion').value;
            const comentario = document.getElementById('comentario').value;

            if (numInterno && ppu && rowIndex) {
                await updateSheet(rowIndex, [numInterno, ppu, estado, litros, ubicacion, comentario]);
            } else {
                showNotification('Todos los campos son obligatorios', '#dc3545');
            }
        });

        document.getElementById('delete-row-btn').addEventListener('click', async function () {
            const numInterno = document.getElementById('num-interno').value;
            const ppu = document.getElementById('ppu').value;
            const rowIndex = await findRowIndexByNumInternoOrPpu(numInterno, ppu);
            if (rowIndex !== -1) {
                await deleteRow(rowIndex);
            } else {
                showNotification('Número Interno no encontrado', '#dc3545');
            }
        });

        document.getElementById('search-row-btn').addEventListener('click', searchRow);

        document.getElementById('clear-btn').addEventListener('click', clearForm);

        document.getElementById('download-btn').addEventListener('click', downloadExcel);

        document.getElementById('print-btn').addEventListener('click', printTable);

        gapi.load('client:auth2', gapiLoaded);
        window.addEventListener('load', () => {
            gisLoaded();
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                accessToken = resp.access_token;
                maybeEnableButtons();
            };

            
            tokenClient.requestAccessToken({ prompt: '' });
        });

        async function findRowIndexByNumInternoOrPpu(numInterno, ppu) {
            console.log("Searching row by Num Interno or PPU...");
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                });
                const data = response.result.values;
                const foundIndex = data.findIndex(row => row[0] === numInterno || row[1] === ppu);
                return foundIndex !== -1 ? foundIndex + 2 : -1;
            } catch (error) {
                console.error('Error finding row:', error);
                showNotification('Error buscando dato', '#dc3545');
                return -1;
            }
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>

</html>
